Bootstrap: docker
From: nvidia/cuda:11.7.1-cudnn8-devel-ubuntu22.04

%labels
    Author YourName
    Version v1.0

%environment
    # Ensure conda & CUDA libs are on PATH
    export PATH=/opt/conda/bin:$PATH
    export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH

%post
    # 1 System deps
    apt-get update && apt-get install -y --no-install-recommends \
        wget git ca-certificates build-essential && \
    rm -rf /var/lib/apt/lists/*

    # 2 Miniconda
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
         -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh

    # 3 Create base env
    /opt/conda/bin/conda create -y -n trainenv python=3.10

    # 4 Install exact deps
    #    If using conda lock file:
    /opt/conda/bin/conda run -n trainenv \
        conda env update -n trainenv --file /workspace/environment.yml

    #    Or, if you exported via pip:
    # /opt/conda/bin/conda run -n trainenv \
    #     pip install -r /workspace/requirements.txt

    # 5 (Optional) clean caches to shrink image
    /opt/conda/bin/conda clean --all -y

%files
    # Copy entire project into container
    . /workspace

%workdir /workspace

%runscript
    # Default entrypoint: call your train script under core/
    exec /opt/conda/bin/conda run -n trainenv \
         python core/train.py "$@"
